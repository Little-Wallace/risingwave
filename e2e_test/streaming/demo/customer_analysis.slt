statement ok
CREATE TABLE txn (
    customer_id VARCHAR,
    tran_amount BIGINT,
    txn_time TIMESTAMP
);

statement ok
insert into txn values
('CS1001',37,'2013-06-08 09:37:54'),
('CS1002',39,'2013-06-08 09:37:54'),
('CS1003',52,'2013-06-08 09:37:54'),
('CS1004',99,'2013-06-08 09:37:54'),
('CS1001',45,'2013-06-08 09:37:54'),
('CS1002',66,'2013-06-08 09:37:54'),
('CS1003',78,'2013-06-08 09:37:54'),
('CS1004',131,'2013-06-08 09:37:54');

statement ok
CREATE MATERIALIZED VIEW time_view as
SELECT customer_id, tran_amount, window_start
FROM tumble(txn, txn_time, interval '60' minute);

statement ok
CREATE MATERIALIZED VIEW rolling_view as
SELECT sum(tran_amount) as sum60, max(tran_amount) as max60, min(tran_amount) as min60, avg(tran_amount) as avg60, customer_id, window_start
FROM time_view group by customer_id, window_start;

statement ok
insert into txn values
('CS1001',37,'2013-06-08 10:30:54'),
('CS1002',39,'2013-06-08 10:30:54'),
('CS1003',52,'2013-06-08 10:30:54'),
('CS1004',99,'2013-06-08 10:30:54'),
('CS1001',45,'2013-06-08 10:30:54'),
('CS1002',66,'2013-06-08 10:30:54'),
('CS1003',78,'2013-06-08 10:30:54'),
('CS1004',131,'2013-06-08 10:30:54');

statement ok
insert into txn values
('CS1001',37,'2013-06-08 11:20:54'),
('CS1002',39,'2013-06-08 11:20:54'),
('CS1003',52,'2013-06-08 11:20:54'),
('CS1004',99,'2013-06-08 11:20:54'),
('CS1001',45,'2013-06-08 11:20:54'),
('CS1002',66,'2013-06-08 11:20:54'),
('CS1003',78,'2013-06-08 11:20:54'),
('CS1004',131,'2013-06-08 11:20:54');

statement ok
CREATE MATERIALIZED VIEW diff_view as
select r1.sum60 - r2.sum60 as diff, r2.customer_id, r1.window_start
from rolling_view as r1 cross join rolling_view as
r2 where r1.window_start = r2.window_start - Interval '60' minute and r1.customer_id = r2.customer_id;



